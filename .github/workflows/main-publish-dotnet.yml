name: ğŸš€ Publish Release

on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*-rc.*" 

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Get version from tag
        id: get-version
        run: |
          version="${GITHUB_REF#refs/tags/v}"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: ğŸ”§ Setup .NET SDK 8.0.105
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.105
          source-url: https://nuget.pkg.github.com/PROCESIO/index.json
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.PROCESIO_BOT_TOKEN }}

      - name: ğŸ“¦ Restore dependencies
        run: dotnet restore

      - name: âš’ï¸ Build project
        run: dotnet build --configuration Release --no-restore

      - name: ğŸ“¦ Pack NuGet package
        run: dotnet pack --no-build --configuration Release Ringhel.Procesio.Action.Core/Ringhel.Procesio.Action.Core.csproj --output ./work/Release
    
      - name: ğŸš€ Publish to GitHub Packages
        run: |
          version="${{ steps.get-version.outputs.version }}"
          echo "ğŸ“¤ Publishing version $version"
          dotnet nuget push ./work/Release/*.nupkg \
            -k ${{ secrets.DEPLOY_KEY }} \
            -s https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json \
            --skip-duplicate
        env:
          GITHUB_TOKEN: ${{ secrets.DEPLOY_KEY }}